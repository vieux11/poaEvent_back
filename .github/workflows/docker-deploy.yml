name: CI/CD Docker Build & Push

# üîπ D√©clencheurs
on:
  push:
    branches:
      - main        # Se d√©clenche sur push sur main
  workflow_dispatch: # Permet un d√©clenchement manuel

# üîπ Variables globales
env:
  DOCKERHUB_REPO: vieuxsage/poa-app
  SOCKET_IMAGE_TAG: socket-server
  ADONIS_IMAGE_TAG: adonis-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Login Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3Ô∏è‚É£ D√©finir des tags dynamiques bas√©s sur commit SHA
      - name: Set Docker tags
        run: |
          echo "SOCKET_TAG=${{ env.SOCKET_IMAGE_TAG }}-${GITHUB_SHA::8}" >> $GITHUB_ENV
          echo "ADONIS_TAG=${{ env.ADONIS_IMAGE_TAG }}-${GITHUB_SHA::8}" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Build & Push Socket server
      - name: Build and push Socket Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./socket-server
          file: ./socket-server/Dockerfile
          push: true
          tags: ${{ env.DOCKERHUB_REPO }}:${{ env.SOCKET_TAG }}

      # 5Ô∏è‚É£ Build & Push Adonis app
      - name: Build and push Adonis Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.DOCKERHUB_REPO }}:${{ env.ADONIS_TAG }}

      # 6Ô∏è‚É£ Affichage des images cr√©√©es
      - name: Show pushed Docker images
        run: |
          echo "Socket image: ${{ env.DOCKERHUB_REPO }}:${{ env.SOCKET_TAG }}"
          echo "Adonis image: ${{ env.DOCKERHUB_REPO }}:${{ env.ADONIS_TAG }}"
